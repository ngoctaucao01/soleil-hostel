name: üöÄ CI/CD Pipeline - Deploy Zero-Downtime

# Ch·∫°y tr√™n: push branch b·∫•t k·ª≥ + PR + manual workflow dispatch
on:
  push:
    branches: [main, develop, "feature/**", "hotfix/**"]
    tags: ["v*"]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

# Kh√¥ng c√≥ CI/CD ƒë√∫ng chu·∫©n = t·ª± nguy·ªán deploy bug ra production
# Timeout to√†n pipeline: 25 ph√∫t
env:
  REGISTRY: ghcr.io
  DOCKER_HUB_REGISTRY: docker.io
  TIMEOUT_MINUTES: 25
  PHP_VERSION: "8.3"
  NODE_VERSION: "20"
  PNPM_VERSION: "9"

jobs:
  # ========== SETUP & CACHE ==========
  setup:
    name: üîß Setup & Cache Keys
    runs-on: ubuntu-latest
    outputs:
      composer-hash: ${{ steps.composer-hash.outputs.hash }}
      pnpm-hash: ${{ steps.pnpm-hash.outputs.hash }}
      docker-hash: ${{ steps.docker-hash.outputs.hash }}
      build-tag: ${{ steps.meta.outputs.tags }}
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üìç Generate cache keys
        id: composer-hash
        run: echo "hash=$(sha256sum backend/composer.lock | cut -c1-16)" >> $GITHUB_OUTPUT

      - name: üìç PNPM cache key
        id: pnpm-hash
        run: echo "hash=$(sha256sum frontend/pnpm-lock.yaml | cut -c1-16)" >> $GITHUB_OUTPUT

      - name: üìç Docker cache key
        id: docker-hash
        run: echo "hash=$(sha256sum backend/Dockerfile frontend/Dockerfile | sha256sum | cut -c1-16)" >> $GITHUB_OUTPUT

      - name: üè∑Ô∏è Generate build tag
        id: meta
        run: |
          echo "tags=soleil-hostel:${{ github.sha }}" >> $GITHUB_OUTPUT

  # ========== BACKEND: COMPOSER INSTALL + OPTIMIZE ==========
  backend-setup:
    name: üì¶ Backend Setup (Composer)
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: üêò Setup PHP ${{ env.PHP_VERSION }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: redis,pdo_mysql,gd,bcmath,ctype,json,mbstring,openssl,tokenizer,xml
          tools: composer,phpstan,psalm
          coverage: xdebug

      - name: üíæ Composer cache
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache
          key: composer-${{ runner.os }}-${{ needs.setup.outputs.composer-hash }}
          restore-keys: composer-${{ runner.os }}-

      - name: üì• Install dependencies
        working-directory: ./backend
        run: |
          composer install \
            --optimize-autoloader \
            --no-dev \
            --no-interaction \
            --prefer-dist

      - name: üîí Verify composer.lock
        working-directory: ./backend
        run: composer validate --strict

      - name: üíæ Cache vendor
        uses: actions/cache/save@v4
        with:
          path: backend/vendor
          key: backend-vendor-${{ needs.setup.outputs.composer-hash }}

  # ========== FRONTEND: PNPM INSTALL + BUILD ==========
  frontend-setup:
    name: üé® Frontend Setup (pnpm)
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: üì¶ Setup Node ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: üöÄ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: üíæ pnpm cache
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-${{ runner.os }}-${{ needs.setup.outputs.pnpm-hash }}
          restore-keys: pnpm-${{ runner.os }}-

      - name: üì• Install dependencies (frozen)
        working-directory: ./frontend
        run: pnpm install --frozen-lockfile

      - name: üíæ Cache node_modules
        uses: actions/cache/save@v4
        with:
          path: frontend/node_modules
          key: frontend-node-${{ needs.setup.outputs.pnpm-hash }}

      - name: üèóÔ∏è Build Vite (Production)
        working-directory: ./frontend
        env:
          VITE_API_URL: "http://localhost:8000/api"
          NODE_ENV: production
        run: pnpm run build

      - name: üì§ Upload dist
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 1

  # ========== STATIC ANALYSIS: PHPStan Level 9 ==========
  phpstan:
    name: üîç PHPStan (Level 9)
    runs-on: ubuntu-latest
    needs: [backend-setup, setup]
    timeout-minutes: 10
    continue-on-error: false
    steps:
      - uses: actions/checkout@v4

      - name: üêò Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: redis,pdo_mysql
          tools: phpstan

      - name: üíæ Restore vendor
        uses: actions/cache/restore@v4
        with:
          path: backend/vendor
          key: backend-vendor-${{ needs.setup.outputs.composer-hash }}

      - name: üî¨ PHPStan analysis (Level 9)
        working-directory: ./backend
        run: phpstan analyse --level=9 app/ --error-format=github

  # ========== STATIC ANALYSIS: Psalm ==========
  psalm:
    name: üîç Psalm (Level 1)
    runs-on: ubuntu-latest
    needs: [backend-setup, setup]
    timeout-minutes: 10
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: üêò Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: redis,pdo_mysql
          tools: psalm

      - name: üíæ Restore vendor
        uses: actions/cache/restore@v4
        with:
          path: backend/vendor
          key: backend-vendor-${{ needs.setup.outputs.composer-hash }}

      - name: üî¨ Psalm analysis
        working-directory: ./backend
        run: psalm --output-format=github

  # ========== STATIC ANALYSIS: Laravel Pint ==========
  pint:
    name: üé® Laravel Pint (Code Style)
    runs-on: ubuntu-latest
    needs: [backend-setup, setup]
    timeout-minutes: 10
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: üêò Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}

      - name: üíæ Restore vendor
        uses: actions/cache/restore@v4
        with:
          path: backend/vendor
          key: backend-vendor-${{ needs.setup.outputs.composer-hash }}

      - name: üé® Check code style
        working-directory: ./backend
        run: vendor/bin/pint --test

  # ========== SECURITY: Composer Audit ==========
  composer-audit:
    name: üîê Composer Audit
    runs-on: ubuntu-latest
    needs: [backend-setup, setup]
    timeout-minutes: 10
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: üêò Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer

      - name: üíæ Restore vendor
        uses: actions/cache/restore@v4
        with:
          path: backend/vendor
          key: backend-vendor-${{ needs.setup.outputs.composer-hash }}

      - name: üîê Audit Composer dependencies
        working-directory: ./backend
        run: composer audit

  # ========== SECURITY: NPM Audit ==========
  npm-audit:
    name: üîê NPM Audit
    runs-on: ubuntu-latest
    needs: [frontend-setup, setup]
    timeout-minutes: 10
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: üì¶ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: üöÄ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: üíæ Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: frontend/node_modules
          key: frontend-node-${{ needs.setup.outputs.pnpm-hash }}

      - name: üîê Audit NPM dependencies
        working-directory: ./frontend
        run: npm audit --audit-level=moderate || true

  # ========== BACKEND TESTS: Pest + Coverage ==========
  backend-tests:
    name: üß™ Backend Tests (Pest)
    runs-on: ubuntu-latest
    needs: [backend-setup, setup]
    timeout-minutes: 15
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: soleil_test
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - 3306:3306

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - name: üêò Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: redis,pdo_mysql
          coverage: xdebug

      - name: üíæ Restore vendor
        uses: actions/cache/restore@v4
        with:
          path: backend/vendor
          key: backend-vendor-${{ needs.setup.outputs.composer-hash }}

      - name: üîß Setup environment
        working-directory: ./backend
        run: |
          cp .env.example .env.testing
          php artisan key:generate --env=testing
          php artisan migrate --env=testing --force

      - name: üß™ Run Pest tests (Parallel)
        working-directory: ./backend
        env:
          APP_ENV: testing
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_DATABASE: soleil_test
          DB_USERNAME: root
          DB_PASSWORD: root
          REDIS_HOST: 127.0.0.1
          REDIS_PORT: 6379
          CACHE_DRIVER: redis
        run: |
          php artisan test \
            --parallel \
            --processes=4 \
            --coverage-clover=coverage.xml \
            --coverage-text \
            --min-coverage-percentage=95

      - name: üìä Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./backend/coverage.xml
          flags: backend
          fail_ci_if_error: true
          verbose: true

      - name: üíæ Cache coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-coverage
          path: backend/coverage.xml
          retention-days: 7

  # ========== CONCURRENT BOOKING STRESS TEST ==========
  booking-stress-test:
    name: üî• Concurrent Booking Test (50 concurrent)
    runs-on: ubuntu-latest
    needs: [backend-setup, setup]
    timeout-minutes: 10
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: soleil_test
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - 3306:3306

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - name: üêò Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: redis,pdo_mysql

      - name: üíæ Restore vendor
        uses: actions/cache/restore@v4
        with:
          path: backend/vendor
          key: backend-vendor-${{ needs.setup.outputs.composer-hash }}

      - name: üîß Setup environment
        working-directory: ./backend
        run: |
          cp .env.example .env.testing
          php artisan key:generate --env=testing
          php artisan migrate --env=testing --force

      - name: üöÄ Start server
        working-directory: ./backend
        run: php artisan serve --host=127.0.0.1 --port=8000 &
        env:
          APP_ENV: testing

      - name: üî• Run concurrent booking stress test
        run: |
          sleep 3  # Wait for server startup
          php backend/tests/stubs/concurrent_booking_test.php

  # ========== FRONTEND TESTS: Vitest ==========
  frontend-unit-tests:
    name: üß™ Frontend Unit Tests (Vitest)
    runs-on: ubuntu-latest
    needs: [frontend-setup, setup]
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: üì¶ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: üöÄ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: üíæ Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: frontend/node_modules
          key: frontend-node-${{ needs.setup.outputs.pnpm-hash }}

      - name: üß™ Run Vitest unit tests
        working-directory: ./frontend
        run: pnpm test:unit --coverage

      - name: üíæ Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./frontend/coverage/coverage-final.json
          flags: frontend
          fail_ci_if_error: false

  # ========== E2E TESTS: Playwright (only on main & tags) ==========
  e2e-tests:
    name: üé≠ E2E Tests (Playwright)
    runs-on: ubuntu-latest
    needs: [backend-setup, frontend-setup, setup]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    timeout-minutes: 15
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: soleil_test
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - 3306:3306

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - name: üêò Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: redis,pdo_mysql

      - name: üíæ Restore vendor
        uses: actions/cache/restore@v4
        with:
          path: backend/vendor
          key: backend-vendor-${{ needs.setup.outputs.composer-hash }}

      - name: üîß Setup backend
        working-directory: ./backend
        run: |
          cp .env.example .env.testing
          php artisan key:generate --env=testing
          php artisan migrate --env=testing --force

      - name: üì¶ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: üöÄ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: üíæ Restore node_modules
        uses: actions/cache/restore@v4
        with:
          path: frontend/node_modules
          key: frontend-node-${{ needs.setup.outputs.pnpm-hash }}

      - name: üé≠ Install Playwright
        working-directory: ./frontend
        run: pnpm exec playwright install --with-deps chromium

      - name: üöÄ Start backend server
        working-directory: ./backend
        run: php artisan serve --host=127.0.0.1 --port=8000 &
        env:
          APP_ENV: testing

      - name: üé® Build frontend
        working-directory: ./frontend
        run: pnpm run build

      - name: üìç Start frontend dev server
        working-directory: ./frontend
        run: pnpm run preview &

      - name: üé≠ Run Playwright E2E tests
        working-directory: ./frontend
        run: pnpm exec playwright test --reporter=html,json
        env:
          PLAYWRIGHT_TEST_BASE_URL: "http://localhost:4173"

      - name: üì§ Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 7

      - name: üì§ Upload test videos
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-videos
          path: frontend/test-results/
          retention-days: 7

  # ========== BUILD DOCKER IMAGE ==========
  docker-build:
    name: üê≥ Build Docker Image
    runs-on: ubuntu-latest
    needs:
      [
        setup,
        backend-tests,
        frontend-unit-tests,
        phpstan,
        backend-setup,
        frontend-setup,
      ]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    timeout-minutes: 20
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: üîë Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: üîë Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üîë Login to Docker Hub
        uses: docker/login-action@v2
        continue-on-error: true
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: üìù Extract metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: |
            ${{ env.REGISTRY }}/${{ github.repository }}
            ${{ env.DOCKER_HUB_REGISTRY }}/${{ secrets.DOCKERHUB_USERNAME }}/soleil-hostel
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-

      - name: üíæ Restore frontend dist
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

      - name: üê≥ Build and push Backend
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ github.repository }}/backend:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ github.repository }}/backend:buildcache,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

  # ========== SECURITY: Trivy Docker Scan ==========
  trivy-scan:
    name: üîê Trivy Docker Scan
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    timeout-minutes: 10
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: üîê Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ needs.docker-build.outputs.image-tag }}
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"

      - name: üì§ Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: "trivy-results.sarif"
          category: "trivy"

  # ========== DEPLOY: Zero-downtime (Forge / Render / Coolify / Dokploy) ==========
  deploy:
    name: üöÄ Deploy Zero-Downtime
    runs-on: ubuntu-latest
    needs: [docker-build, backend-tests, e2e-tests, phpstan, composer-audit]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    timeout-minutes: 15
    environment:
      name: production
      url: https://solelhotel.com
    steps:
      - uses: actions/checkout@v4

      - name: üîß Setup deployment tools
        run: |
          sudo apt-get update && sudo apt-get install -y curl jq

      - name: üìç Determine deployment target
        id: deploy-target
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          fi

      - name: üöÄ Deploy to Forge (Option 1)
        if: secrets.FORGE_API_TOKEN != ''
        run: |
          curl -X POST https://forge.laravel.com/api/v1/servers/${{ secrets.FORGE_SERVER_ID }}/sites/${{ secrets.FORGE_SITE_ID }}/deployment/trigger \
            -H "Authorization: Bearer ${{ secrets.FORGE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "commit": "${{ github.sha }}",
              "branch": "${{ github.ref_name }}"
            }'

      - name: üöÄ Deploy to Render (Option 2)
        if: secrets.RENDER_DEPLOY_HOOK != ''
        run: |
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}" \
            -H "Content-Type: application/json" \
            -d '{
              "commit": "${{ github.sha }}",
              "branch": "${{ github.ref_name }}"
            }'

      - name: üöÄ Deploy to Coolify (Option 3)
        if: secrets.COOLIFY_API_TOKEN != ''
        run: |
          curl -X POST https://coolify.io/api/v1/applications/${{ secrets.COOLIFY_APP_ID }}/deploy \
            -H "Authorization: Bearer ${{ secrets.COOLIFY_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "git_commit": "${{ github.sha }}"
            }'

      - name: üéØ Health check post-deploy
        run: |
          for i in {1..30}; do
            if curl -s -o /dev/null -w "%{http_code}" https://solelhotel.com/api/health | grep -q "200"; then
              echo "‚úÖ Health check passed"
              exit 0
            fi
            echo "‚è≥ Attempt $i/30 - waiting for deployment..."
            sleep 10
          done
          echo "‚ùå Health check failed"
          exit 1

      - name: üîÑ Warm up cache post-deploy
        run: |
          curl -X POST https://solelhotel.com/api/cache/warmup \
            -H "Authorization: Bearer ${{ secrets.INTERNAL_API_TOKEN }}" \
            -H "Content-Type: application/json"

      - name: üîÑ Run database migrations
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          curl -X POST https://solelhotel.com/api/migrations/run \
            -H "Authorization: Bearer ${{ secrets.INTERNAL_API_TOKEN }}" \
            -H "Content-Type: application/json"

      - name: üéâ Slack notification (Success)
        if: success()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "‚úÖ Soleil Hostel deployment successful",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "‚úÖ *Deployment Successful*\n*Commit*: <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>\n*Branch*: ${{ github.ref_name }}\n*Environment*: Production"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: üö® Slack notification (Failure)
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "‚ùå Soleil Hostel deployment failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "‚ùå *Deployment Failed*\n*Commit*: <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>\n*Branch*: ${{ github.ref_name }}\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

  # ========== SEMANTIC RELEASE (Auto version bump) ==========
  release:
    name: üì¶ Semantic Release
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 10
    permissions:
      contents: write
      packages: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üîñ Semantic Release
        uses: cycjimmy/semantic-release-action@v3
        with:
          semantic_version: 21
          branches: |
            [
              '+([0-9])?(.{+([0-9]),x}).x',
              'main',
              'develop',
              {name: 'hotfix/*', prerelease: 'hotfix', channel: 'hotfix'}
            ]
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ========== CLEANUP: Remove old artifacts & cache ==========
  cleanup:
    name: üßπ Cleanup Artifacts
    runs-on: ubuntu-latest
    if: always()
    timeout-minutes: 5
    steps:
      - name: üßπ Delete old artifacts
        uses: geekyeggo/delete-artifact@v2
        with:
          name: |
            frontend-dist
            backend-coverage
            playwright-report
            e2e-videos
          minCreatedAge: 7d
