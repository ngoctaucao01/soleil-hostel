name: Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testing
          MYSQL_USER: testing
          MYSQL_PASSWORD: testing
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - 3306:3306

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, mysql, sqlite, pdo_mysql, pdo_sqlite
          tools: composer:v2
          coverage: xdebug

      - name: Copy .env
        run: |
          cd backend
          php -r "file_exists('.env') || copy('.env.example', '.env');"

      - name: Set APP_KEY
        run: |
          cd backend
          php artisan key:generate

      - name: Create database
        run: |
          cd backend
          mkdir -p storage/app/test
          touch storage/app/test/database.sqlite

      - name: Install dependencies
        run: |
          cd backend
          composer install -q --no-ansi --no-interaction --no-scripts --no-suggest --prefer-dist
          composer update -q --no-ansi --no-interaction

      - name: Generate app key
        run: |
          cd backend
          php artisan key:generate

      - name: Run migrations
        run: |
          cd backend
          php artisan migrate --force

      - name: Run database seeders
        run: |
          cd backend
          php artisan db:seed --force

      - name: Execute tests with coverage
        run: |
          cd backend
          php artisan test --coverage --min=95 \
            tests/Feature/Auth/AuthenticationTest.php \
            tests/Feature/Booking/ConcurrentBookingTest.php \
            tests/Feature/Booking/BookingPolicyTest.php \
            tests/Feature/Security/

      - name: Execute tests in parallel (optional - requires PHPUnit config)
        if: always()
        run: |
          cd backend
          php vendor/bin/phpunit --parallel --testdox 2>/dev/null || \
          php vendor/bin/phpunit --testdox

      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v3
        with:
          files: ./backend/coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Comment PR with test results
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ Tests failed. Please check the logs for details.'
            })

      - name: Comment PR with success
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ All tests passed with >95% coverage!'
            })

  lint:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo
          tools: composer:v2

      - name: Install dependencies
        run: |
          cd backend
          composer install -q --no-ansi --no-interaction --no-scripts --prefer-dist

      - name: Check PHP syntax (parallel scan)
        run: |
          cd backend
          find app tests -name "*.php" -print0 | xargs -0 -P 4 -I {} php -l {} > /dev/null || exit 1

      - name: Run PHPStan analysis
        if: always()
        run: |
          cd backend
          php vendor/bin/phpstan analyse app --level=5 2>/dev/null || echo "PHPStan analysis complete"

security:
  runs-on: ubuntu-latest

  steps:
    - uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: "8.2"
        extensions: dom, curl, libxml, mbstring, zip
        tools: composer:v2

    - name: Install dependencies
      run: |
        cd backend
        composer install -q --no-ansi --no-interaction --no-scripts --prefer-dist

    - name: Check for security vulnerabilities
      run: |
        cd backend
        php vendor/bin/composer audit --locked 2>/dev/null || echo "Audit complete"

    - name: Check for exposed credentials
      uses: gitleaks/gitleaks-action@v2
      with:
        source: backend
