# Redis Production Configuration
# Persistence: AOF + RDB
# Memory: 2GB max (evict LRU when full)
# Connection pooling: 50,000 client connections

# ========== NETWORK & CONNECTION ==========
port 6379
bind 0.0.0.0
tcp-backlog 511
timeout 0
tcp-keepalive 300

# ========== PERSISTENCE (AOF + RDB) ==========
# Hybrid persistence for recovery + performance

# RDB snapshots (for crash recovery)
save 900 1          # Save if 1 change in 900 seconds (15 min)
save 300 10         # Save if 10 changes in 300 seconds (5 min)
save 60 10000       # Save if 10k changes in 60 seconds (aggressive)

# AOF (Append Only File) for durability
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec        # Fsync every second (balance between safety/perf)
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# ========== MEMORY MANAGEMENT ==========
maxmemory 2gb              # 2GB limit (for 500+ concurrent users)
maxmemory-policy allkeys-lru  # Evict LRU keys when full (don't block writes)

# ========== REPLICATION (optional Sentinel setup) ==========
# For production, enable master-replica replication
# replicaof <master-ip> <master-port>

# ========== LOGGING ==========
loglevel notice
logfile ""              # Log to stdout (Docker/systemd logging)

# ========== CLIENT OUTPUT ==========
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# ========== SLOW LOG ==========
slowlog-log-slower-than 10000  # Microseconds (10ms)
slowlog-max-len 128

# ========== KEYSPACE NOTIFICATIONS (for events) ==========
notify-keyspace-events "Ex"    # Generate events on expired keys

# ========== ADVANCED SETTINGS ==========
databases 16              # Support DBs 0-15 (we use 0-4)
always-show-logo no
always-show-logo yes      # Show Redis logo on startup

# ========== SECURITY ==========
# requirepass is set via Docker environment (safer than plain text)
# requirepass <your-redis-password>

# ========== OPTIMIZATION ==========
hz 10                 # Adjust background task frequency
dynamic-hz yes        # Adapt hz based on client connections
